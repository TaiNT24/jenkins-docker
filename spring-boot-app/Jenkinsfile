pipeline {
    agent {
        label 'java-slave'
    }
    environment {
        APP_PORT = '3001'
        JAR_NAME = 'spring-boot-app-0.0.1-SNAPSHOT.jar'
    }
    stages {
        stage('Verify Tools') {
            steps {
                sh '''
                    java -version
                    mvn -version
                '''
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                dir('spring-boot-app') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }
        
        stage('Test') {
            steps {
                dir('spring-boot-app') {
                    sh 'mvn test'
                }
            }
        }

        stage('Archive') {
            steps {
                dir('spring-boot-app') {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }

        stage('Deploy') {
            steps {
                dir('spring-boot-app') {
                    script {
                        // Kill any process running on the specified port
                        sh """
                            PORT=${APP_PORT}
                            PID=\$(lsof -t -i:\${PORT} || echo "")
                            if [ ! -z "\${PID}" ]; then
                                echo "Killing process \${PID} running on port \${PORT}"
                                kill -9 \${PID}
                            fi
                        """
                        
                        // Run the new jar file
                        sh """
                            ls target/
                            nohup java -jar target/${JAR_NAME} --server.port=${APP_PORT} > app.log 2>&1 &
                            sleep 30  # Wait for application to start
                            
                            # Check if application is running
                            if lsof -i:${APP_PORT}; then
                                echo "Application deployed successfully"
                            else
                                echo "Failed to deploy application"
                                exit 1
                            fi
                        """
                    }
                }
            }
        }
    }
}