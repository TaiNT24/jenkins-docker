pipeline {
    agent {
        label 'java-slave'
    }
    environment {
        APP_PORT = '3001'
        JAR_NAME = 'hello-world-spring-1.0.0.jar'
    }
    stages {
        stage('Verify Tools') {
            steps {
                sh '''
                    java -version
                    mvn -version
                '''
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                dir('spring-boot-app') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }
        
        stage('Test') {
            steps {
                dir('spring-boot-app') {
                    sh 'mvn test'
                }
            }
        }

        stage('Archive') {
            steps {
                dir('spring-boot-app') {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }

        stage('Deploy') {  
            steps {  
                sh '''  
                    cat \\> run.sh \\<\\< 'EOL'  
                    #!/bin/bash  
                    PID_FILE=application.pid  

                    # Kill existing process if running  
                    if [ -f $PID_FILE ]; then  
                        kill -9 $(cat $PID_FILE) || true  
                        rm $PID_FILE  
                    fi  

                    # Start the application  
                    nohup java -jar target/${JAR_NAME} --server.port=${APP_PORT} > app.log 2>&1 &  
                    echo $! > $PID_FILE  
                    sleep 10  # Give some time for the application to start  

                    # Check if process is running  
                    if ps -p $(cat $PID_FILE) > /dev/null; then  
                        echo "Application started successfully"  
                    else  
                        echo "Failed to start application"  
                        exit 1  
                    fi  
                    EOL  
                    '''
                    
                    sh '''
                        chmod +x run.sh  
                        ./run.sh  
                    '''
            }  
        }  
    }
}